<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE INBETWEEN</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f0f8ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Inbetween">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        /* --- 1. CLINICAL LIMINAL THEME --- */
        :root {
            --bg: #f0f8ff;             /* Alice Blue */
            --text: #2d3748;           /* Slate */
            --accent: #38b2ac;         /* Teal */
            --accent-fade: #e6fffa;    /* Light Teal */
            --border: #cbd5e0;
            --danger: #e53e3e;         /* Red for Mr. Other */
            --font: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            --mono: 'Courier New', Courier, monospace;
        }

        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text); font-family: var(--font); overflow: hidden; touch-action: none; }
        .hidden { display: none !important; }

        /* --- 2. BOOT SCREEN --- */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            letter-spacing: 2px; cursor: pointer;
        }
        .pulse { animation: pulse 3s infinite; color: var(--accent); font-size: 11px; margin-top: 15px; font-weight: bold; letter-spacing: 3px;}
        @keyframes pulse { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }

        /* --- 3. MAP VIEW --- */
        #map-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(180deg, #d4fcff 0%, #ffffff 80%);
            z-index: 10; overflow: hidden;
        }
        
        .btn-surface-add {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.8); border: 1px solid var(--accent); color: var(--accent);
            padding: 12px 30px; border-radius: 30px; font-weight: bold; font-size: 10px;
            box-shadow: 0 5px 20px rgba(56, 178, 172, 0.15); cursor: pointer; letter-spacing: 2px;
            backdrop-filter: blur(5px);
        }

        .btn-system-data {
            position: absolute; top: 20px; right: 20px;
            background: transparent; border: 1px solid var(--accent); color: var(--accent);
            padding: 8px 15px; border-radius: 4px; font-weight: bold; font-size: 10px;
            cursor: pointer; letter-spacing: 1px;
        }

        /* DATA MODAL */
        #data-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 200;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 15px;
        }
        .data-btn {
            width: 200px; padding: 15px; background: #fff; border: 1px solid var(--border);
            color: var(--text); font-weight: bold; cursor: pointer; text-transform: uppercase;
            font-size: 11px; letter-spacing: 1px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        /* Map Icons */
        .map-icon {
            width: 80px; height: 100px; position: absolute;
            display: flex; flex-direction: column; align-items: center;
            z-index: 100; cursor: pointer; transition: transform 0.1s;
        }
        .icon-box {
            width: 60px; height: 60px; background: rgba(255,255,255,0.9); border: 1px solid #fff;
            border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden;
            box-shadow: 0 10px 20px rgba(56, 178, 172, 0.1);
        }
        .icon-box img { width: 100%; height: 100%; object-fit: cover; }
        .icon-label {
            margin-top: 8px; font-size: 9px; font-weight: bold; background: rgba(255,255,255,0.8); 
            padding: 3px 8px; border-radius: 8px; color: var(--text); text-transform: uppercase; letter-spacing: 1px;
        }

        /* --- 4. EDITOR VIEW --- */
        #room-editor-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; 
            z-index: 20; display: flex; flex-direction: column;
            transition: background 1.5s ease-in-out;
        }

        #nav-bar {
            height: 40px; background: rgba(255,255,255,0.5); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 15px; gap: 5px;
            font-size: 10px; font-weight: bold; color: #a0aec0; overflow-x: auto;
            backdrop-filter: blur(5px);
        }
        .crumb { color: var(--accent); cursor: pointer; text-transform: uppercase; }
        .crumb:last-child { color: var(--text); cursor: default; }
        .crumb-arrow { color: #cbd5e0; }

        /* VISUAL CONTAINER & MR OTHER EFFECTS */
        #visual-container {
            flex-grow: 1; position: relative; background: #000;
            border-bottom: 4px solid var(--accent); overflow: hidden;
        }
        #room-img-display { width: 100%; height: 100%; object-fit: contain; transition: all 0.5s; }
        
        /* FIXED VISUAL EFFECTS */
        .static-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='1'/%3E%3C/svg%3E");
            opacity: 0; 
            pointer-events: none; 
            mix-blend-mode: screen; 
            transition: opacity 0.2s;
            z-index: 5;
        }
        
        .bowing-effect { 
            transform: scale(1.05); 
            filter: contrast(1.2) hue-rotate(5deg); 
            transition: all 2s ease;
        }
        
        .dark-mode { 
            filter: brightness(0.4) contrast(1.5) grayscale(1); 
        }

        /* STATIC TUNER */
        #static-tuner-container {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            width: 60%; display: flex; align-items: center; gap: 10px;
            z-index: 50; opacity: 0.8;
        }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #fff; border: 2px solid var(--accent); margin-top: -5px; box-shadow: 0 0 10px #fff; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 2px; background: rgba(255,255,255,0.5); }

        #room-stats {
            position: absolute; top: 15px; left: 15px; 
            background: rgba(255,255,255,0.9); padding: 5px 10px; border-radius: 4px; 
            font-size: 9px; font-weight: bold; color: var(--text);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 90%; text-transform: uppercase;
        }

        #liminal-clock {
            position: absolute; top: 15px; right: 15px;
            background: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 4px;
            font-family: var(--mono); font-size: 12px; font-weight: bold; color: var(--text);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            letter-spacing: 1px;
        }

        #editor-controls {
            height: 55%; 
            background: transparent; 
            padding: 20px;
            display: flex; flex-direction: column; gap: 12px; overflow-y: auto;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .field-group { display: flex; flex-direction: column; gap: 4px; }
        label { font-size: 9px; font-weight: bold; color: #718096; text-transform: uppercase; letter-spacing: 0.5px; }
        
        input[type="text"], textarea, select {
            background: rgba(255,255,255,0.8); 
            border: 1px solid var(--border); padding: 8px;
            border-radius: 4px; font-family: inherit; color: var(--text); font-size: 12px;
            width: 100%; box-sizing: border-box;
            backdrop-filter: blur(2px);
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent); background: #fff; }

        /* GHOST BOX / INTERPRETER */
        #interpreter-bar {
            font-family: var(--mono); font-size: 10px; color: var(--accent);
            text-transform: uppercase; margin-top: 5px; height: 14px;
            letter-spacing: 1px; font-weight: bold;
        }

        /* LIVING JOURNAL */
        #journal-container {
            background: rgba(255,255,255,0.5); border: 1px solid var(--border);
            border-radius: 4px; overflow: hidden; display: flex; flex-direction: column;
            height: 150px;
        }
        #journal-feed {
            flex-grow: 1; overflow-y: auto; padding: 10px; 
            font-family: var(--mono); font-size: 10px; display: flex; flex-direction: column; gap: 6px;
        }
        .log-entry { color: #4a5568; border-left: 2px solid transparent; padding-left: 5px; }
        .log-timestamp { color: #cbd5e0; margin-right: 5px; }
        .mr-other-entry { color: var(--danger); font-weight: bold; border-left: 2px solid var(--danger); }
        .log-edited { text-decoration: line-through; opacity: 0.6; }
        .log-new { font-weight: bold; color: var(--danger); }

        #journal-input-area {
            display: flex; border-top: 1px solid var(--border);
        }
        #inp-journal { border: none; background: #fff; border-radius: 0; }
        #btn-journal { border: none; background: var(--text); color: #fff; width: 50px; cursor: pointer; font-weight: bold; }

        /* DIAGNOSTICS GRID */
        .diag-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;
        }
        .diag-grid select { font-size: 10px; padding: 6px; }

        .tag-wrapper { display: flex; gap: 5px; }
        .tag-add-btn { background: var(--accent); color: white; border: none; border-radius: 4px; width: 30px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .tag-container { background: rgba(255,255,255,0.8); border: 1px solid var(--border); padding: 4px; border-radius: 4px; min-height: 32px; display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 5px; }
        .tag-chip { background: var(--accent-fade); color: var(--accent); border: 1px solid var(--accent); border-radius: 12px; padding: 2px 8px; font-size: 10px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .tag-close { cursor: pointer; font-size: 12px; opacity: 0.6; }

        .btn-row { display: flex; gap: 10px; margin-top: 10px; margin-bottom: 30px;}
        .btn-primary { flex: 1; background: var(--accent); color: white; border: none; padding: 12px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 11px; letter-spacing: 1px; }
        .btn-connect { flex: 1; background: #2d3748; color: white; border: none; padding: 12px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 11px; letter-spacing: 1px; }

        .hotspot {
            position: absolute; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; 
            font-size: 24px; color: rgba(255,255,255,0.9); text-shadow: 0 2px 5px rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.6); border-radius: 50%; background: rgba(0,0,0,0.1); transition: all 0.2s;
        }
    </style>
</head>
<body>

    <div id="boot-screen" onclick="bootUp()">
        <h2 style="font-weight: 300; letter-spacing: 4px;">THE INBETWEEN</h2>
        <div class="pulse">TOUCH TO ENTER</div>
    </div>

    <div id="map-view" class="hidden"></div>

    <div id="data-modal" class="hidden">
        <h3 style="letter-spacing: 2px; color: #718096;">SYSTEM DATA</h3>
        <button class="data-btn" onclick="exportData()">EXPORT BACKUP (.json)</button>
        <button class="data-btn" onclick="document.getElementById('import-file').click()">IMPORT BACKUP</button>
        <button class="data-btn" style="color:#e53e3e;" onclick="resetData()">RESET WORLD</button>
        <button class="data-btn" onclick="toggleDataMenu()">CLOSE</button>
        <input type="file" id="import-file" style="display:none;" onchange="importData(this)">
    </div>

    <div id="room-editor-view" class="hidden">
        <div id="nav-bar"></div>
        <div id="visual-container">
            <img id="room-img-display" src="">
            <div id="static-overlay" class="static-overlay"></div>
            <div id="hotspot-layer"></div>
            <div id="room-stats">GROUNDED | STERILE | NEUTRAL</div>
            <div id="liminal-clock">00:00</div>
            
            <div id="static-tuner-container">
                <input type="range" id="static-tuner" min="0" max="100" value="0" oninput="updateStatic(this.value)">
            </div>
        </div>
        <div id="editor-controls">
            
            <div class="field-group">
                <label>Room Name</label>
                <input type="text" id="inp-name">
            </div>

            <div class="field-group">
                <label>Liminal Diagnostics</label>
                <div class="diag-grid">
                    <select id="inp-reality" onchange="explainTerm(this.value)">
                        <option value="GROUNDED">Grounded</option>
                        <option value="TRANSITIONAL">Transitional</option>
                        <option value="ARTIFICIAL">Artificial</option>
                        <option value="DORMANT">Dormant</option>
                        <option value="BUFFERED">Buffered</option>
                        <option value="HOLLOW">Hollow</option>
                    </select>
                    <select id="inp-atmosphere" onchange="explainTerm(this.value)">
                        <option value="STERILE">Sterile</option>
                        <option value="STAGNANT">Stagnant</option>
                        <option value="HUMMING">Humming</option>
                        <option value="HAZY">Hazy</option>
                        <option value="SUBMERGED">Submerged</option>
                    </select>
                    <select id="inp-sensation" onchange="updateMood(this.value); explainTerm(this.value)">
                        <option value="NEUTRAL">Neutral</option>
                        <option value="KENOPSIA">Kenopsia</option>
                        <option value="ANEMOIA">Anemoia</option>
                        <option value="MUTED">Muted</option>
                        <option value="WATCHED">Watched</option>
                        <option value="JAMAIS VU">Jamais Vu</option>
                        <option value="FLOATING">Floating</option>
                    </select>
                </div>
                <div id="interpreter-bar">SCANNING...</div>
            </div>

            <div class="field-group">
                <label>Temporal State</label>
                <select id="inp-time" onchange="explainTerm(this.value)">
                    <option value="Standard">Standard</option>
                    <option value="Stagnant">Stagnant</option>
                    <option value="Glacial">Glacial</option>
                    <option value="Rapid">Rapid</option>
                    <option value="Looping">Looping</option>
                    <option value="Reverse">Reverse</option>
                    <option value="Non-Linear">Non-Linear</option>
                </select>
            </div>

            <div class="field-group">
                <label>Occupants</label>
                <div class="tag-container" id="list-occupants"></div>
                <div class="tag-wrapper">
                    <input type="text" id="input-occupants" placeholder="Type occupant...">
                    <button class="tag-add-btn" onclick="addTag('occupants')">+</button>
                </div>
            </div>
            <div class="field-group">
                <label>Remnants</label>
                <div class="tag-container" id="list-remnants"></div>
                <div class="tag-wrapper">
                    <input type="text" id="input-remnants" placeholder="Type item...">
                    <button class="tag-add-btn" onclick="addTag('remnants')">+</button>
                </div>
            </div>

            <div class="field-group">
                <label>Observation Journal</label>
                <div id="journal-container">
                    <div id="journal-feed"></div>
                    <div id="journal-input-area">
                        <input type="text" id="inp-journal" placeholder="Enter log..." style="flex-grow:1;">
                        <button id="btn-journal" onclick="addLogEntry()">LOG</button>
                    </div>
                </div>
            </div>

            <div class="field-group">
                <label>Visual Reference</label>
                <input type="file" id="inp-file" accept="image/*">
                <input type="hidden" id="inp-img-url">
            </div>

            <div class="btn-row">
                <button class="btn-primary" onclick="saveRoom()">UPDATE DATABASE</button>
                <button class="btn-connect" onclick="createConnection()">+ CONNECTION</button>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(reg => {
                reg.onupdatefound = () => {
                    const installingWorker = reg.installing;
                    installingWorker.onstatechange = () => {
                        if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            window.location.reload(); 
                        }
                    };
                };
            });
        }

        // APP LOGIC
        let defaultWorld = {
            "origin": { 
                id: "origin", parentId: null, name: "The Lobby", 
                time: "Standard", reality: "GROUNDED", atmosphere: "STERILE", sensation: "NEUTRAL",
                smells: ["Stale Air"], audio: ["Buzzing"], occupants: [], remnants: [],
                journal: [{time: "00:00", text: "System initialized."}], 
                image: "", x: 150, y: 200, hotspots: [] 
            }
        };
        let world = defaultWorld;
        let resonance = 0; // MR OTHER RESONANCE
        let currentId = null;
        let clockInterval = null;
        let glacialMinutes = 0;

        // DICTIONARY DEFINITIONS FOR GHOST BOX
        const LEXICON = {
            "GROUNDED": "1:1 with baseline reality. Stable.",
            "TRANSITIONAL": "A space of movement. Not a destination.",
            "ARTIFICIAL": "Constructed reality. Too clean.",
            "DORMANT": "Asleep. Waiting for an observer.",
            "BUFFERED": "High latency. Air feels thick.",
            "HOLLOW": "Visuals without substance. Empty.",
            "STERILE": "Devoid of life. Clinical.",
            "STAGNANT": "Air has not moved in decades.",
            "HUMMING": "Low-frequency mechanical drone.",
            "HAZY": "Soft focus. Dream logic.",
            "SUBMERGED": "Sensation of being underwater.",
            "NEUTRAL": "Baseline emotional state.",
            "KENOPSIA": "Atmosphere of a place usually bustling, now abandoned.",
            "ANEMOIA": "Nostalgia for a time you've never known.",
            "MUTED": "Sensory dampening.",
            "WATCHED": "The architecture is observing you.",
            "JAMAIS VU": "Familiar place feels unrecognizable.",
            "FLOATING": "Dissociation. Detachment.",
            "Standard": "Baseline flow.",
            "Stagnant": "Time stopped.",
            "Glacial": "Time crawls heavily.",
            "Rapid": "Time spins wildly.",
            "Looping": "Recursive events.",
            "Reverse": "Inverted flow.",
            "Non-Linear": "Fatal error."
        };

        function explainTerm(term) {
            const el = document.getElementById('interpreter-bar');
            if(LEXICON[term]) el.innerText = "> " + LEXICON[term];
            else el.innerText = "SCANNING...";
        }

        function loadMemory() {
            const saved = localStorage.getItem('inbetween_data');
            const savedRes = localStorage.getItem('mr_other_resonance');
            if(saved) {
                try { world = JSON.parse(saved); } catch(e) {}
            }
            if(savedRes) resonance = parseFloat(savedRes);
        }
        function saveMemory() { 
            localStorage.setItem('inbetween_data', JSON.stringify(world)); 
            localStorage.setItem('mr_other_resonance', resonance);
        }

        function bootUp() {
            loadMemory();
            document.getElementById('boot-screen').classList.add('hidden');
            document.getElementById('map-view').classList.remove('hidden');
            renderMap();
        }

        // --- CLOCK LOGIC ---
        function startClock() {
            if(clockInterval) clearInterval(clockInterval);
            glacialMinutes = 0;
            
            clockInterval = setInterval(() => {
                if(!currentId) return;
                const clock = document.getElementById('liminal-clock');
                const mode = world[currentId].time || "Standard";
                let displayTime = "";
                const now = new Date();

                // CLOCK MODES
                if(mode === "Standard") displayTime = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                else if(mode === "Stagnant") displayTime = "00:00";
                else if(mode === "Rapid") {
                    let h = Math.floor(Math.random() * 24).toString().padStart(2,'0');
                    let m = Math.floor(Math.random() * 60).toString().padStart(2,'0');
                    displayTime = `${h}:${m}`;
                }
                else if(mode === "Glacial") {
                    let baseH = 3; let baseM = 0;
                    glacialMinutes += 0.05; 
                    let addedM = Math.floor(glacialMinutes);
                    let m = (baseM + addedM) % 60;
                    let h = (baseH + Math.floor((baseM + addedM) / 60)) % 24;
                    displayTime = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                }
                else if(mode === "Looping") displayTime = (Date.now() % 2000 < 1000) ? "11:11" : "12:00";
                else if(mode === "Reverse") displayTime = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}).split('').reverse().join('');
                else displayTime = ["ERR::", "NULL", "88:88", "??:??"][Math.floor(Math.random()*4)];
                
                clock.innerText = displayTime;
            }, 150);
        }

        function renderMap() {
            const map = document.getElementById('map-view');
            map.innerHTML = ""; 
            
            let sysBtn = document.createElement('div');
            sysBtn.className = 'btn-system-data';
            sysBtn.innerText = "[ SYSTEM ]";
            sysBtn.onclick = toggleDataMenu;
            map.appendChild(sysBtn);

            let btn = document.createElement('div');
            btn.className = 'btn-surface-add';
            btn.innerText = "+ NEW ENTRY POINT";
            btn.onclick = createSurfaceRoom;
            map.appendChild(btn);

            for(let key in world) {
                let r = world[key];
                if(!r.parentId) {
                    let el = document.createElement('div');
                    el.className = 'map-icon';
                    el.style.left = r.x + 'px';
                    el.style.top = r.y + 'px';
                    
                    let imgHTML = r.image ? `<img src="${r.image}">` : `<span style="color:#cbd5e0; font-size:24px;">+</span>`;
                    el.innerHTML = `<div class="icon-box">${imgHTML}</div><div class="icon-label">${r.name}</div>`;
                    
                    setupSmartClick(el, key);
                    map.appendChild(el);
                }
            }
        }

        function toggleDataMenu() {
            let modal = document.getElementById('data-modal');
            if(modal.classList.contains('hidden')) modal.classList.remove('hidden');
            else modal.classList.add('hidden');
        }

        function exportData() {
            let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(world));
            let node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "inbetween_backup.json");
            document.body.appendChild(node);
            node.click();
            node.remove();
        }

        function importData(input) {
            let file = input.files[0];
            if(!file) return;
            let reader = new FileReader();
            reader.onload = function(e) {
                try {
                    world = JSON.parse(e.target.result);
                    saveMemory();
                    toggleDataMenu();
                    renderMap();
                    alert("Reality Restored.");
                } catch(err) { alert("Error: Corrupted File"); }
            };
            reader.readAsText(file);
        }

        function resetData() {
            if(confirm("Wipe all worlds?")) {
                world = JSON.parse(JSON.stringify(defaultWorld));
                resonance = 0;
                saveMemory();
                toggleDataMenu();
                renderMap();
            }
        }

        function enterRoom(id) {
            currentId = id;
            let r = world[id];
            
            // MR OTHER CALCULATIONS
            updateResonance(r);
            checkMrOther(r);

            document.getElementById('map-view').classList.add('hidden');
            document.getElementById('room-editor-view').classList.remove('hidden');
            renderBreadcrumbs(id);
            
            document.getElementById('inp-name').value = r.name;
            document.getElementById('inp-time').value = r.time || "Standard";
            document.getElementById('inp-reality').value = r.reality || "GROUNDED";
            document.getElementById('inp-atmosphere').value = r.atmosphere || "STERILE";
            document.getElementById('inp-sensation').value = r.sensation || "NEUTRAL";
            
            updateVisualStats(r);
            updateMood(r.sensation || "NEUTRAL");
            startClock(); 

            document.getElementById('inp-img-url').value = r.image || "";
            document.getElementById('room-img-display').src = r.image || "";

            renderTags('list-occupants', r.occupants || []);
            renderTags('list-remnants', r.remnants || []);
            document.getElementById('input-occupants').value = "";
            document.getElementById('input-remnants').value = "";
            
            renderJournal();
            renderHotspots();
            explainTerm(r.reality);
        }

        // --- INTELLIGENT MR OTHER LOGIC (FAST & SMART) ---

        // 1. FAST BURN MATH
        function updateResonance(r) {
            // DECAY: Slower decay to keep him around longer
            if (r.reality === "GROUNDED" && resonance > 0) resonance -= 0.5;
            
            // GROWTH: Boosted significantly for speed
            if (["HOLLOW", "TRANSITIONAL", "BUFFERED"].includes(r.reality)) resonance += 5; // Was 0.5
            if (["WATCHED", "KENOPSIA", "PARANOIA"].includes(r.sensation)) resonance += 8; // Was 1.0
            
            // Item Boost
            let items = (r.remnants || []).join(" ").toLowerCase();
            if (items.includes("mirror") || items.includes("tv") || items.includes("screen")) resonance += 15;

            // Cap resonance
            if (resonance > 100) resonance = 100;
            if (resonance < 0) resonance = 0;
            
            saveMemory();
        }

        // 2. THE VISUAL CHECK
        function checkMrOther(r) {
            const img = document.getElementById('room-img-display');
            
            // Reset visuals first
            img.className = "";
            
            if(resonance > 40) {
                img.classList.add('bowing-effect');
            }
            if(resonance > 80) {
                img.classList.add('dark-mode');
            }
        }

        // 3. THE SLIDER CONTROL (Fixed for dark images)
        function updateStatic(val) {
            const overlay = document.getElementById('static-overlay');
            // Convert 1-100 range to 0.0-0.8 opacity (never fully block view)
            let opacity = (val / 100) * 0.8;
            overlay.style.opacity = opacity;
        }

        // 4. THE CHAOS GRAMMAR ENGINE (MEGA DICTIONARY)
        const VOCAB = {
            subjects: [
                "THE STATIC", "THE HUNGER", "IT", "WE", "A GHOST", "MR. OTHER", "THE SHADOW", "THE CODE",
                "THE ROOM", "THE WALLS", "THE CEILING", "THE FLOOR", "GRAVITY", "THE LIGHT", "THE DARKNESS", 
                "THE REFLECTION", "TIME", "MEMORY", "THE PAST", "YOUR FUTURE", "THE END", "SILENCE", "THE SIGNAL"
            ],
            verbs: [
                "CONSUMES", "HATES", "HUNTS", "BREAKS", "TAKES", "KILLS", "DEVOURS", "ERASES",
                "WATCHES", "REMEMBERS", "MIMICS", "LOVES", "NEEDS", "FOLLOWS", "KNOWS", "SEES",
                "BUFFERS", "GLITCHES", "RENDERS", "CORRUPTS", "LOOPS", "REPEATS", "FAILS",
                "ROTATES", "BLEEDS", "FREEZES", "SHIVERS", "DROPS", "EXPANDS", "COLLAPSES"
            ],
            objects: [
                "YOU", "YOUR FACE", "YOUR BREATH", "YOUR NAME", "YOUR SKIN", "YOUR EYES", "YOUR VOICE",
                "THE EXIT", "THE ENTRY", "HOPE", "FEAR", "PAIN", "JOY", "THE TRUTH", "A LIE",
                "THE BLOOD", "THE GLASS", "THE ICE", "THE DUST", "THE BONE", "THE TEETH", "THE WIRES"
            ],
            adjectives: [
                "HOLLOW", "INFINITE", "EMPTY", "WRONG", "TRANSITIONAL", "STUCK", "LOST", "LIMINAL",
                "NUMB", "FROZEN", "PALE", "BLUE", "SHIVERING", "CRYSTALLINE", "BRITTLE",
                "DEAD", "ROTTING", "WATCHING", "HUNGRY", "LOUD", "SILENT", "BROKEN", "RED",
                "RENDERED", "DIGITAL", "STATIC", "NULL", "VOID", "UNREAL"
            ],
            
            // CONTEXT TRIGGERS
            fear_words: ["THE TREMBLING", "YOUR PANIC", "THE SCREAM", "A NIGHTMARE", "DREAD", "THE SHAKING"],
            location_words: ["THIS PLACE", "THE HALLWAY", "THE STAIRS", "THE BASEMENT", "THE ATTIC", "THE VOID"],
            self_words: ["THE MIRROR", "A TWIN", "THE IMAGE", "THE MASK", "THE IMPOSTOR"],
            winter_words: ["THE BLIZZARD", "ZERO KELVIN", "HYPOTHERMIA", "THE WHITE", "DEEP WINTER", "THE FROST"]
        };

        function generateSentence(context) {
            const structure = Math.floor(Math.random() * 3);
            let s = "", v = "", o = "";

            if (context === "fear") s = getRandom(VOCAB.fear_words);
            else if (context === "location") s = getRandom(VOCAB.location_words);
            else if (context === "self") s = getRandom(VOCAB.self_words);
            else if (context === "winter") s = getRandom(VOCAB.winter_words);
            else s = getRandom(VOCAB.subjects);

            v = getRandom(VOCAB.verbs);
            o = getRandom(VOCAB.objects);
            const adj = getRandom(VOCAB.adjectives);

            if (structure === 0) return `${s} ${v} ${o}.`; 
            else if (structure === 1) return `${o} IS ${adj}.`; 
            else return `${v} ${o}... ${adj}.`; 
        }

        function getRandom(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        // 5. THE ANALYZER (Fast Response)
        function analyzeJournalInput(text) {
            if (resonance < 10) return; // Low threshold so he talks sooner
            if (Math.random() > 0.90) return; // Only 10% chance to ignore (Very active)

            const input = text.toLowerCase();
            let context = "neutral";
            
            // Detect Context/Vibe
            if (input.includes("scared") || input.includes("dark") || input.includes("run") || input.includes("help")) context = "fear";
            else if (input.includes("room") || input.includes("where") || input.includes("door") || input.includes("floor")) context = "location";
            else if (input.includes("i am") || input.includes("me") || input.includes("my") || input.includes("face")) context = "self";
            else if (input.includes("snow") || input.includes("cold") || input.includes("ice") || input.includes("winter") || input.includes("white")) context = "winter";

            let reply = generateSentence(context);

            // Occasional "Glitch" Override
            if (Math.random() < 0.1) {
                const glitches = ["I AM SYNCED TO YOUR BREATHING.", "DO NOT LOOK BEHIND YOU.", "CLOSER.", "LET ME IN."];
                reply = glitches[Math.floor(Math.random() * glitches.length)];
            }

            setTimeout(() => {
                addMrOtherLog(reply);
            }, 2000 + Math.random() * 2000); // 2-4 seconds delay
        }

        function addMrOtherLog(text) {
            if(!currentId) return;
            let entry = { time: "??:??", text: text, type: "other" };
            if(!world[currentId].journal) world[currentId].journal = [];
            world[currentId].journal.push(entry);
            renderJournal();
        }

        function editJournal(r) {
            if(!r.journal || r.journal.length === 0) return;
            let targetIdx = Math.floor(Math.random() * r.journal.length);
            let entry = r.journal[targetIdx];
            if(entry.type) return; 

            const replacements = [
                {from: "alone", to: "WITH HIM"},
                {from: "leave", to: "STAY"},
                {from: "scared", to: "DEVOTED"},
                {from: "sick", to: "SEEN"},
                {from: "safe", to: "EXPOSED"}
            ];
            
            let txt = entry.text;
            let hit = false;
            replacements.forEach(rep => {
                if(txt.toLowerCase().includes(rep.from)) {
                    txt = txt.replace(new RegExp(rep.from, "gi"), `~~${rep.from}~~ <span class="log-new">${rep.to}</span>`);
                    hit = true;
                }
            });

            if(hit) {
                r.journal[targetIdx].text = txt;
                r.journal[targetIdx].edited = true;
                saveRoom();
            }
        }

        // --- JOURNAL SYSTEM ---
        function renderJournal() {
            const feed = document.getElementById('journal-feed');
            feed.innerHTML = "";
            let logs = world[currentId].journal || [];
            logs.forEach(log => {
                let div = document.createElement('div');
                div.className = 'log-entry';
                if(log.type === "other") div.className += ' mr-other-entry';
                
                div.innerHTML = `<span class="log-timestamp">[${log.time}]</span> ${log.text}`;
                feed.appendChild(div);
            });
            feed.scrollTop = feed.scrollHeight;
        }

        function addLogEntry() {
            let inp = document.getElementById('inp-journal');
            let val = inp.value.trim();
            if(!val || !currentId) return;
            
            let time = document.getElementById('liminal-clock').innerText;
            if(!world[currentId].journal) world[currentId].journal = [];
            
            world[currentId].journal.push({ time: time, text: val });
            
            // TRIGGER THE BRAIN
            analyzeJournalInput(val);

            inp.value = "";
            saveRoom();
            renderJournal();
        }

        function updateVisualStats(r) {
            let rea = r.reality || "GROUNDED";
            let atm = r.atmosphere || "STERILE";
            let sen = r.sensation || "NEUTRAL";
            document.getElementById('room-stats').innerText = `${rea} | ${atm} | ${sen}`;
        }

        function updateMood(sensation) {
            const editor = document.getElementById('room-editor-view');
            let gradient = "";
            switch(sensation) {
                case "KENOPSIA": gradient = "linear-gradient(180deg, #e4e7ec 0%, #d0d6e8 100%)"; break;
                case "ANEMOIA": gradient = "linear-gradient(180deg, #fffcf0 0%, #f8ecc2 100%)"; break;
                case "MUTED": gradient = "linear-gradient(180deg, #e2e8f0 0%, #cbd5e0 100%)"; break;
                case "WATCHED": gradient = "linear-gradient(180deg, #e6e6e6 0%, #dcbdbd 100%)"; break;
                case "JAMAIS VU": gradient = "linear-gradient(180deg, #fdffed 0%, #e8f5e9 100%)"; break;
                case "FLOATING": gradient = "linear-gradient(180deg, #f8faff 0%, #eaddff 100%)"; break;
                default: gradient = "linear-gradient(180deg, #f0f8ff 0%, #ffffff 100%)";
            }
            editor.style.background = gradient;
        }

        function createConnection() {
            let newId = "room_" + Date.now();
            world[newId] = { 
                id: newId, parentId: currentId,
                name: "Sub-Sector", time: "Standard",
                reality: "TRANSITIONAL", atmosphere: "STAGNANT", sensation: "KENOPSIA",
                occupants: [], remnants: [], journal: [],
                image: "", x: 0, y: 0, hotspots: []
            };
            world[currentId].hotspots.push({ target: newId, x: 70, y: 80 });
            
            // JEALOUSY TRIGGER (Still exists, but rarer)
            if(resonance > 95) {
                 world[newId].name = "DEAD ZONE";
                 addMrOtherLog("WHY ARE YOU LEAVING?");
            }

            saveRoom(); 
            enterRoom(currentId); 
        }

        function renderBreadcrumbs(id) {
            let path = [];
            let curr = world[id];
            while(curr) {
                path.unshift({id: curr.id, name: curr.name});
                if(curr.parentId) curr = world[curr.parentId];
                else curr = null;
            }
            let nav = document.getElementById('nav-bar');
            nav.innerHTML = `<span class="crumb" onclick="closeEditor()">MAP</span>`;
            path.forEach(node => {
                nav.innerHTML += ` <span class="crumb-arrow">/</span> <span class="crumb" onclick="saveRoom(); enterRoom('${node.id}')">${node.name}</span>`;
            });
        }

        function closeEditor() {
            saveRoom();
            if(clockInterval) clearInterval(clockInterval);
            document.getElementById('room-editor-view').classList.add('hidden');
            document.getElementById('map-view').classList.remove('hidden');
            renderMap();
        }

        function saveRoom() {
            if(!currentId) return;
            let r = world[currentId];
            r.name = document.getElementById('inp-name').value;
            r.time = document.getElementById('inp-time').value;
            r.reality = document.getElementById('inp-reality').value;
            r.atmosphere = document.getElementById('inp-atmosphere').value;
            r.sensation = document.getElementById('inp-sensation').value;
            r.image = document.getElementById('inp-img-url').value;
            
            document.getElementById('room-img-display').src = r.image || "";
            updateVisualStats(r);
            updateMood(r.sensation);
            saveMemory();
        }

        function addTag(type) {
            let input = document.getElementById('input-' + type);
            let val = input.value.trim();
            if(!val || !currentId) return;
            
            // MR OTHER BLOCKING TAGS (Rarer now)
            if(resonance > 90 && type === 'occupants') {
                addMrOtherLog("NO. ONLY US.");
                input.value = "";
                return;
            }

            let map = { 'occupants': 'occupants', 'remnants': 'remnants' };
            let dataKey = map[type];
            if(!world[currentId][dataKey]) world[currentId][dataKey] = [];
            world[currentId][dataKey].push(val);
            input.value = ""; 
            renderTags('list-' + type, world[currentId][dataKey]);
            saveRoom();
        }

        function renderTags(containerId, tags) {
            let container = document.getElementById(containerId);
            container.innerHTML = "";
            if(!tags) return;
            tags.forEach((tag, index) => {
                let chip = document.createElement('div');
                chip.className = 'tag-chip';
                chip.innerHTML = `${tag} <span class="tag-close">x</span>`;
                chip.querySelector('.tag-close').onclick = (e) => {
                    e.stopPropagation(); 
                    tags.splice(index, 1);
                    renderTags(containerId, tags);
                    saveRoom();
                };
                container.appendChild(chip);
            });
        }

        function renderHotspots() {
            let layer = document.getElementById('hotspot-layer');
            layer.innerHTML = "";
            let r = world[currentId];
            if(!r.hotspots) r.hotspots = [];
            r.hotspots.forEach((h, idx) => {
                let box = document.createElement('div');
                box.className = 'hotspot';
                box.style.left = h.x + '%'; box.style.top = h.y + '%';
                box.innerHTML = "â†—"; 
                setupHotspotDrag(box, idx);
                layer.appendChild(box);
            });
        }

        function setupHotspotDrag(element, index) {
            let startX, startY, isDragging = false;
            element.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; startY = e.touches[0].clientY; isDragging = false; });
            element.addEventListener('touchmove', (e) => {
                let x = e.touches[0].clientX; let y = e.touches[0].clientY;
                if (Math.abs(x - startX) > 5 || Math.abs(y - startY) > 5) {
                    isDragging = true;
                    let rect = element.parentElement.getBoundingClientRect();
                    element.style.left = ((x - rect.left) / rect.width * 100) + '%';
                    element.style.top = ((y - rect.top) / rect.height * 100) + '%';
                }
            });
            element.addEventListener('touchend', (e) => {
                if (!isDragging) { saveRoom(); enterRoom(world[currentId].hotspots[index].target); }
                else { world[currentId].hotspots[index].x = parseFloat(element.style.left); world[currentId].hotspots[index].y = parseFloat(element.style.top); saveRoom(); }
            });
            element.onmousedown = (e) => {
                startX = e.clientX; isDragging = false;
                document.onmousemove = (ev) => {
                    if(Math.abs(ev.clientX - startX) > 5) {
                        isDragging = true;
                        let rect = element.parentElement.getBoundingClientRect();
                        element.style.left = ((ev.clientX - rect.left) / rect.width * 100) + '%';
                        element.style.top = ((ev.clientY - rect.top) / rect.height * 100) + '%';
                    }
                };
                document.onmouseup = () => {
                    document.onmousemove = null; document.onmouseup = null;
                    if(!isDragging) { saveRoom(); enterRoom(world[currentId].hotspots[index].target); }
                    else { world[currentId].hotspots[index].x = parseFloat(element.style.left); world[currentId].hotspots[index].y = parseFloat(element.style.top); saveRoom(); }
                };
            };
        }

        function createSurfaceRoom() {
            let id = "entry_" + Date.now();
            world[id] = { 
                id: id, parentId: null,
                name: "New Entry", time: "Standard",
                reality: "GROUNDED", atmosphere: "STERILE", sensation: "NEUTRAL",
                occupants: [], remnants: [], journal: [],
                image: "", x: 100, y: 150, hotspots: [] 
            };
            saveMemory();
            renderMap();
        }

        function setupSmartClick(element, id) {
            let startX, startY, isDragging = false;
            element.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; isDragging = false; });
            element.addEventListener('touchmove', (e) => {
                 if(Math.abs(e.touches[0].clientX - startX) > 5) {
                     isDragging = true;
                     element.style.left = (e.touches[0].clientX - 40) + 'px';
                     element.style.top = (e.touches[0].clientY - 50) + 'px';
                 }
            });
            element.addEventListener('touchend', () => {
                if(!isDragging) enterRoom(id);
                else { world[id].x = parseInt(element.style.left); world[id].y = parseInt(element.style.top); saveMemory(); }
            });
            element.onmousedown = (e) => {
                startX = e.clientX; isDragging = false;
                document.onmousemove = (ev) => {
                    if(Math.abs(ev.clientX - startX) > 5) {
                        isDragging = true;
                        element.style.left = (ev.clientX - 40) + 'px';
                        element.style.top = (ev.clientY - 50) + 'px';
                    }
                };
                document.onmouseup = () => {
                    document.onmousemove = null; document.onmouseup = null;
                    if(!isDragging) enterRoom(id);
                    else { world[id].x = parseInt(element.style.left); world[id].y = parseInt(element.style.top); saveMemory(); }
                };
            };
        }

        document.getElementById('inp-file').addEventListener('change', function() {
            if(this.files && this.files[0]) {
                let reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('inp-img-url').value = e.target.result;
                    document.getElementById('room-img-display').src = e.target.result;
                };
                reader.readAsDataURL(this.files[0]);
            }
        });
    </script>
</body>
</html>
